---
title: "SCTLD_juvies"
output: html_document
date: "2024-04-15"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Data analysis for the 16S SCTLD juvenile experiment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr) 
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
library(gridExtra)
library(multcomp)
library(reshape)
library(factoextra)
library(reshape2)
library(vegan) 
library(pairwiseAdonis)
library("scales")
packageVersion("scales")
library(RColorBrewer)
library(colorRamps)
library(devtools)
library(phyloseq)
library(readr)
library(vegan)
library(ape)
library(geosphere)
library(ade4)
library(microbiome)  
library(knitr)
```

#Start analysis here: load in RData if needed
```{r}
load("RData/Bac.seq.SCTLD.RData") #load cleaned data 

sampdata <- as(sample_data(Bac.seq.S.2), "data.frame") #look at samp data
```

#Set up, Bac.s relative abundaces: Bac.seq.rel (Bac.seq for alpha)
```{r}        
#make relative abundance df Bac.seq
Bac.seq.rel  = transform_sample_counts(Bac.seq.S.2, function(x) x / sum(x) )  #save as RELA DIVs
data.Bac.seq.rel.sd <- as(sample_data(Bac.seq.rel), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel) > 0, Bac.seq.rel) #this removes any OTU with 0s
``` 


Unifrac
```{r}
#make unifrac matrix
Bac.seq.wu.all <- phyloseq::distance(Bac.seq.rel, method = "wunifrac")
s.u.samp.df <- as(sample_data(Bac.seq.rel), "data.frame") #sample df
s.u.samp.df$code<-paste(s.u.samp.df$treatment,s.u.samp.df$time.point) #treatment*timepoint code

#adonixs test between species: p=0.001 
set.seed(30)
adonis2(Bac.seq.wu.all ~ species, data = s.u.samp.df)

# Pairwise comparisons using pairwise.adonis2 between species pairs: all sig diff
pairwise_results <- pairwise.adonis2(Bac.seq.wu.all ~ species, data = s.u.samp.df)
print(pairwise_results)

#adonixs test between species*treatment*time.point: all sig
set.seed(30)
adonis2(Bac.seq.wu.all ~ species*treatment*time.point, data = s.u.samp.df)

# Pairwise comparisons using pairwise.adonis2 between species pairs: all sig diff
pairwise_results <- pairwise.adonis2(Bac.seq.wu.all ~ species*treatment*time.point, data = s.u.samp.df)
print(pairwise_results)

#Plot
#nmds
unifrac.all <- ordinate(Bac.seq.rel, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.all)
scores.ord.u_RelA_stats<-as.data.frame(cbind(vegan::scores(unifrac.all, display="sites")))  
     unifrac.all.sd <- as(sample_data(Bac.seq.rel), "data.frame") #sample df

scores.ord.u_RelA_stats$species <- unifrac.all.sd$species
scores.ord.u_RelA_stats$treatment <- unifrac.all.sd$treatment
scores.ord.u_RelA_stats$time.point <- unifrac.all.sd$time.point
scores.ord.u_RelA_stats$code<-paste(scores.ord.u_RelA_stats$treatment, scores.ord.u_RelA_stats$time.point)
scores.ord.u_RelA_stats$code <- factor(scores.ord.u_RelA_stats$code, levels = c("control initial", "control final", "disease final"))

#plot 
p<-ggplot(scores.ord.u_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = code, shape=time.point), size = 4) +
  scale_color_manual(values = c("gray", "darkblue", "red")) +
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = code), linetype = 2) +
  ggtitle("NMDS 16s by sample type") +
  theme_classic()+
  facet_wrap(~species);p
ggsave(filename = "Figures/nmds_16s_all.pdf", plot = p, width = 12, height = 6, units = "in")

```

#Initial only - differences between species
```{r}
Bac.seq.S.rel.initial<-subset_samples (Bac.seq.rel, time.point=="initial")
Bac.seq.S.rel.initial = prune_taxa(taxa_sums(Bac.seq.S.rel.initial) > 0, Bac.seq.S.rel.initial) 
#make unifrac matrix
Bac.seq.wu.ini <- phyloseq::distance(Bac.seq.S.rel.initial, method = "wunifrac")
s.u.samp.df.ini <- as(sample_data(Bac.seq.S.rel.initial), "data.frame") #sample df

  
#adonixs test between sample types: p=0.001 between species types
set.seed(30)
adonis_results<-adonis2(Bac.seq.wu.ini ~ species, data = s.u.samp.df.ini)
# Pairwise comparisons using pairwise.adonis2
pairwise_results <- pairwise.adonis2(Bac.seq.wu.ini ~ species, data = s.u.samp.df.ini)
print(pairwise_results)

# Homogeneity of dispersion test
set.seed(30)
betadisper_result <- betadisper(Bac.seq.wu.ini, s.u.samp.df.ini$species, type = "centroid")
permutest_result <- permutest(betadisper_result)

# Tukey's Honest Significant Difference test
tukey_result <- TukeyHSD(betadisper_result, ordered = FALSE, conf.level = 0.95)

#plot
#nmds
unifrac.ini <- ordinate(Bac.seq.S.rel.initial, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.ini)
print(unifrac.ini)# stress score 0.117
scores.ord.u_RelA_stats<-as.data.frame(cbind(vegan::scores(unifrac.ini, display="sites")))  
     unifrac.ini.sd <- as(sample_data(Bac.seq.S.rel.initial), "data.frame") #sample df

scores.ord.u_RelA_stats$species <- unifrac.ini.sd$species

p<-ggplot(scores.ord.u_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = species), size = 4) +
    scale_color_manual(values=c("orange","turquoise3","seagreen"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = species), linetype = 2) +
  ggtitle("Microbiome NMDS") +
  theme_classic();p
ggsave("Figures/initial_NMDS.pdf", plot = p, width = 8, height = 6)


#TOP OTUS not just top taxa  ####
# Selecting top 10 OTUs

#Cnat 
Bac.seq.cnat.i.control<-subset_samples(Bac.seq.S.rel.initial, species=="Colpophyllia natans")
TopNOTUsCnat.cont.i = names(sort(taxa_sums(Bac.seq.cnat.i.control), TRUE)[1:10])
cnat.abund.cont = prune_taxa(TopNOTUsCnat.cont.i, Bac.seq.cnat.i.control)
cnat.abund.melt.cont <- psmelt(cnat.abund.cont)
cnat.abund.melt.cont$top.group <- "abund"

#dlab 
Bac.seq.dlab.i.control<-subset_samples(Bac.seq.S.rel.initial, species=="Diploria labyrinthiformis")
TopNOTUsDlab.cont.i = names(sort(taxa_sums(Bac.seq.dlab.i.control), TRUE)[1:10])
dlab.abund.cont = prune_taxa(TopNOTUsDlab.cont.i, Bac.seq.dlab.i.control)
dlab.abund.melt.cont <- psmelt(dlab.abund.cont)
dlab.abund.melt.cont$top.group <- "abund"

#pstr
Bac.seq.pstr.i.control<-subset_samples(Bac.seq.S.rel.initial, species=="Pseudodiploria strigosa")
TopNOTUspstr.cont.i = names(sort(taxa_sums(Bac.seq.pstr.i.control), TRUE)[1:10])
pstr.abund.cont = prune_taxa(TopNOTUspstr.cont.i, Bac.seq.pstr.i.control)
pstr.abund.melt.cont <- psmelt(pstr.abund.cont)
pstr.abund.melt.cont$top.group <- "abund"

##Venn Diagram 
cnat.list <- unique(cnat.abund.melt.cont$Genus)
dlab.list <- unique(dlab.abund.melt.cont$Genus)
pstr.list <- unique(pstr.abund.melt.cont$Genus)

candidates <- list("C. natans" = cnat.list, "D. labyrinthiformis" = dlab.list, "P. strigosa"=pstr.list)

library(VennDiagram)
venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#E69F00", "#56B4E9", "indianred3"), alpha = 0.5)
pdf(file = "Figures/venn_abund_initial.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("CNAT DLAB PSTR", "CNAT PSTR", "DLAB PSTR", "CNAT PSTR")
View(overlap)

#Elements in both Set1 and Set2
both <- intersect(cnat.list, dlab.list,pstr.list)

# Elements only in Set1
only_set1 <- setdiff(cnat.list, dlab.list)

# Elements only in Set2
only_set2 <- setdiff(cnat.list,pstr.list)

only_set3 <- setdiff(dlab.list,pstr.list)


# Print results
print(both)
print(only_set1)
print(only_set2)
```

C.nat Initial only
```{r}
#cnat
Bac.seq.rel.cnat<-subset_samples(Bac.seq.rel, species=="Colpophyllia natans")
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.cnat) > 0, Bac.seq.rel.cnat) #this removes any OTU with 0s
Bac.seq.rel.cnat<-subset_samples(Bac.seq.rel.cnat, time.point=="initial")

# Access the OTU table from your phyloseq object
otu_table <- otu_table(Bac.seq.rel.cnat)

# Count the number of non-zero counts for each taxa across all samples
taxa_presence <- rowSums(otu_table > 0) 
num_taxa_present_in_all_samples <- sum(taxa_presence == ncol(otu_table))# Count the number of taxa present in all samples
print(num_taxa_present_in_all_samples)# Print the result - it's zero

# Calculate prevalence of taxa
taxa_prevalence <- prevalence(Bac.seq.rel.cnat, detection = 1/100)
tax_table <- tax_table(Bac.seq.rel.cnat)

# Filter taxa with prevalence greater than 1%
taxa_greater_than_80_percent <- taxa_prevalence[taxa_prevalence > 0.80]
taxa_names_greater_than_80_percent <- tax_table[taxa_greater_than_80_percent,]

# Count the number of taxa
num_taxa_greater_than_80_percent <- length(taxa_names_greater_than_80_percent)

# Print the result
print(length(taxa_greater_than_80_percent))
print(taxa_names_greater_than_80_percent)


# Count unique taxa
taxa_levels <- as.data.frame(tax_table(Bac.seq.rel.cnat))
unique_species <- n_distinct(taxa_levels$Species)
unique_genera <- n_distinct(taxa_levels$Genus)
unique_families <- n_distinct(taxa_levels$Family)

print(unique_species)
print(unique_genera)
print(unique_families)

# Extract OTU names
otu_names <- taxa_names(Bac.seq.rel.cnat)

# Count the number of unique OTUs
num_unique_otus <- length(unique(otu_names))

# Print the number of unique OTUs
print(num_unique_otus)

# Count unique OTUs or ASVs (this is too high res)
otu_table <- otu_table(Bac.seq.rel.cnat)
unique_otus <- sum(otu_table > 0, na.rm = TRUE)
print(unique_otus)

core.taxa.standard <- core_members(Bac.seq.rel.cnat, detection = 0.0001, prevalence = .95)
core.taxa.standard

#Try again with genus level
cnat.rel.gen <- aggregate_taxa(Bac.seq.rel.cnat, "Family")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)
par(cex = 0.2)  # Adjust the value (0.8) to make the text smaller

p1 <- plot_core(cnat.rel.gen, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences,
                
                detections = detections, min.prevalence = .95) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

cnat.genus <- aggregate_taxa(Bac.seq.rel.cnat, "Genus")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)

p1 <- plot_core(cnat.genus, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences, 
                detections = detections, min.prevalence = .5) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

#bar plot
#family
Bac.fam.cnat <- Bac.seq.rel.cnat %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.cnat <- psmelt(Bac.fam.cnat)


  ggplot(Bac.fam.melt.cnat, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("C. natans Family")   # Add plot title here
  
  #bar plot
  
#phy
Bac.phy.cnat <- Bac.seq.rel.cnat %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.cnat <- psmelt(Bac.phy.cnat)

  ggplot(Bac.phy.melt.cnat, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("C. natans Phylum")   # Add plot title here
  
### HE from ACE
  
  ##Core Analysis
  cnat.core <- core(Bac.seq.rel.cnat, detection = 0.0001, prevalence = .99)
cnat.core.taxa <- tax_table(cnat.core)
View(as.data.frame(cnat.core.taxa))


#Trial with a tax glom at family??
t0.fam <- tax_glom(Bac.seq.rel, "Family", NArm = TRUE)
t0.fam.core <- core(t0.fam, detection = 0.0001, prevalence = .99)
t0.fam.core.taxa <- tax_table(t0.fam.core)
View(as.data.frame(t0.fam.core.taxa))

#cnat
#cnat <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#cnat.ra <- transform_sample_counts(cnat, function(x) x/ sum(x))

cnat.core <- core(Bac.seq.rel.cnat, detection = 0.0001, prevalence = .97)
cnat.core.taxa <- tax_table(cnat.core)
View(as.data.frame(cnat.core.taxa))
cnat.core.melt <- psmelt(cnat.core)
cnat.core.melt$top.group <- "core"
write.csv(cnat.core.melt, "stats/cnat_core.csv")

##Plotting
#check # of OTUs
p.cnat <- ggplot(cnat.core.melt, aes(x = Sample, y = Genus, size = Abundance)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2","indianred3")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.cnat
print(p.cnat)
ggsave("Figures/cnat_core_bubble.pdf")

```

D. lab overview
```{r}
#dlab
Bac.seq.rel.dlab<-subset_samples(Bac.seq.rel, species=="Diploria labyrinthiformis")
data.Bac.seq.rel.dlab = prune_taxa(taxa_sums(Bac.seq.rel.dlab) > 0, Bac.seq.rel.dlab) #this removes any OTU with 0s
Bac.seq.rel.dlab<-subset_samples(Bac.seq.rel.dlab, time.point=="initial")

# Access the OTU table from your phyloseq object
otu_table <- otu_table(Bac.seq.rel.dlab)

# Count the number of non-zero counts for each taxa across all samples
taxa_presence <- rowSums(otu_table > 0) 
num_taxa_present_in_all_samples <- sum(taxa_presence == ncol(otu_table))# Count the number of taxa present in all samples
print(num_taxa_present_in_all_samples)# Print the result - it's zero

# Calculate prevalence of taxa
taxa_prevalence <- prevalence(Bac.seq.rel.dlab, detection = 1/100)
tax_table <- tax_table(Bac.seq.rel.dlab)


# Filter taxa with prevalence greater than 1%
taxa_greater_than_80_percent <- taxa_prevalence[taxa_prevalence > 0.990]
taxa_names_greater_than_80_percent <- tax_table[taxa_greater_than_80_percent,]

# Count the number of taxa
num_taxa_greater_than_80_percent <- length(taxa_names_greater_than_80_percent)

# Print the result
print(length(taxa_greater_than_80_percent))
print(taxa_names_greater_than_80_percent)


# Count unique taxa
taxa_levels <- as.data.frame(tax_table(Bac.seq.rel.dlab))
unique_species <- n_distinct(taxa_levels$Species)
unique_genera <- n_distinct(taxa_levels$Genus)
unique_families <- n_distinct(taxa_levels$Family)

print(unique_species)
print(unique_genera)
print(unique_families)

# Extract OTU names
otu_names <- taxa_names(Bac.seq.rel.dlab)

# Count the number of unique OTUs
num_unique_otus <- length(unique(otu_names))

# Print the number of unique OTUs
print(num_unique_otus)

# Count unique OTUs or ASVs (this is too high res)
otu_table <- otu_table(Bac.seq.rel.dlab)
unique_otus <- sum(otu_table > 0, na.rm = TRUE)
print(unique_otus)

core.taxa.standard <- core_members(Bac.seq.rel.dlab, detection = 0.0001, prevalence = .95)
core.taxa.standard

#Try again with genus level (lots of unclassified, so at family)
dlab.rel.gen <- aggregate_taxa(Bac.seq.rel.dlab, "Family")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)
par(cex = 0.2)  # Adjust the value (0.8) to make the text smaller

p1 <- plot_core(dlab.rel.gen, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences,
                
                detections = detections, min.prevalence = .90) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

dlab.genus <- aggregate_taxa(Bac.seq.rel.dlab, "Genus")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)

p1 <- plot_core(dlab.genus, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences, 
                detections = detections, min.prevalence = .5) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

#bar plot
#family
Bac.fam.dlab <- Bac.seq.rel.dlab %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.dlab <- psmelt(Bac.fam.dlab)


  ggplot(Bac.fam.melt.dlab, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("C. natans Family")   # Add plot title here
  
  #bar plot
#phy
Bac.phy.dlab <- Bac.seq.rel.dlab %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.dlab <- psmelt(Bac.phy.dlab)

  ggplot(Bac.phy.melt.dlab, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("D.lab Phylum")   # Add plot title here
  
  
  ### HE from ACE
  
  ##Core Analysis
dlab.core <- core(Bac.seq.rel.dlab, detection = 0.0001, prevalence = .99)
dlab.core.taxa <- tax_table(dlab.core)
View(as.data.frame(dlab.core.taxa))


#Trial with a tax glom at family??
t0.fam <- tax_glom(Bac.seq.rel, "Family", NArm = TRUE)
t0.fam.core <- core(t0.fam, detection = 0.0001, prevalence = .99)
t0.fam.core.taxa <- tax_table(t0.fam.core)
View(as.data.frame(t0.fam.core.taxa))

#dlab
#dlab <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#dlab.ra <- transform_sample_counts(dlab, function(x) x/ sum(x))

dlab.core <- core(Bac.seq.rel.dlab, detection = 0.0001, prevalence = .97)
dlab.core.taxa <- tax_table(dlab.core)
View(as.data.frame(dlab.core.taxa))
dlab.core.melt <- psmelt(dlab.core)
dlab.core.melt$top.group <- "core"
write.csv(dlab.core.melt, "stats/dlab_core.csv")

##Plotting
#check # of OTUs
p.dlab <- ggplot(dlab.core.melt, aes(x = Sample, y = Genus, size = Abundance)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2","indianred3")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.dlab
print(p.dlab)
ggsave("Figures/dlab_core_bubble.pdf")

```
Pstr overview
```{r}
#pstr
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel, species=="Pseudodiploria strigosa")
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel.pstr, time.point=="initial")

data.Bac.seq.rel.pstr = prune_taxa(taxa_sums(Bac.seq.rel.pstr) > 0, Bac.seq.rel.pstr) #this removes any OTU with 0s

# Access the OTU table from your phyloseq object
otu_table <- otu_table(Bac.seq.rel.pstr)

# Count the number of non-zero counts for each taxa across all samples
taxa_presence <- rowSums(otu_table > 0) 
num_taxa_present_in_all_samples <- sum(taxa_presence == ncol(otu_table))# Count the number of taxa present in all samples
print(num_taxa_present_in_all_samples)# Print the result - it's zero

# Calculate prevalence of taxa
taxa_prevalence <- prevalence(Bac.seq.rel.pstr, detection = 1/100)
tax_table <- tax_table(Bac.seq.rel.pstr)


# Filter taxa with prevalence greater than 1%
taxa_greater_than_80_percent <- taxa_prevalence[taxa_prevalence > 0.990]
taxa_names_greater_than_80_percent <- tax_table[taxa_greater_than_80_percent,]

# Count the number of taxa
num_taxa_greater_than_80_percent <- length(taxa_names_greater_than_80_percent)

# Print the result
print(length(taxa_greater_than_80_percent))
print(taxa_names_greater_than_80_percent)


# Count unique taxa
taxa_levels <- as.data.frame(tax_table(Bac.seq.rel.pstr))
unique_species <- n_distinct(taxa_levels$Species)
unique_genera <- n_distinct(taxa_levels$Genus)
unique_families <- n_distinct(taxa_levels$Family)

print(unique_species)
print(unique_genera)
print(unique_families)

# Extract OTU names
otu_names <- taxa_names(Bac.seq.rel.pstr)

# Count the number of unique OTUs
num_unique_otus <- length(unique(otu_names))

# Print the number of unique OTUs
print(num_unique_otus)

# Count unique OTUs or ASVs (this is too high res)
otu_table <- otu_table(Bac.seq.rel.pstr)
unique_otus <- sum(otu_table > 0, na.rm = TRUE)
print(unique_otus)

core.taxa.standard <- core_members(Bac.seq.rel.pstr, detection = 0.0001, prevalence = .99)
core.taxa.standard

#Try again with genus level (lots of unclassified, so at family)
pstr.rel.gen <- aggregate_taxa(Bac.seq.rel.pstr, "Family")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)
par(cex = 0.2)  # Adjust the value (0.8) to make the text smaller

p1 <- plot_core(pstr.rel.gen, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences,
                
                detections = detections, min.prevalence = .90) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

pstr.genus <- aggregate_taxa(Bac.seq.rel.pstr, "Genus")
prevalences <- seq(.05, 1, .05)
detections <- round(10^seq(log10(1e-5), log10(.2), length = 10), 3)

p1 <- plot_core(pstr.genus, 
                plot.type = "heatmap", 
                colours = rev(brewer.pal(5, "RdBu")),
                prevalences = prevalences, 
                detections = detections, min.prevalence = .5) +
    xlab("Detection Threshold (Relative Abundance (%))")
p1 <- p1 + theme_bw() + ylab("ASVs")
p1

#bar plot
#family
Bac.fam.pstr <- Bac.seq.rel.pstr %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.pstr <- psmelt(Bac.fam.pstr)


  g<-ggplot(Bac.fam.melt.pstr, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
 # xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Family")   # Add plot title here
  ggsave("Figures/pstr_ini_fam.pdf", plot = g, width =8, height = 6) 

  #bar plot
#phy
Bac.phy.pstr <- Bac.seq.rel.pstr %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr <- psmelt(Bac.phy.pstr)

  j<-ggplot(Bac.phy.melt.pstr, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Phylum")   # Add plot title here
    ggsave("Figures/pstr_ini_phy.pdf", plot = j, width =8, height = 6) 

  
  ### HE from ACE
  
  ##Core Analysis
pstr.core <- core(Bac.seq.rel.pstr, detection = 0.0001, prevalence = .97)
pstr.core.taxa <- tax_table(pstr.core)
View(as.data.frame(pstr.core.taxa))


#Trial with a tax glom at family??
t0.fam <- tax_glom(Bac.seq.rel, "Family", NArm = TRUE)
t0.fam.core <- core(t0.fam, detection = 0.0001, prevalence = .99)
t0.fam.core.taxa <- tax_table(t0.fam.core)
View(as.data.frame(t0.fam.core.taxa))

#pstr
#pstr <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#pstr.ra <- transform_sample_counts(pstr, function(x) x/ sum(x))

pstr.core <- core(Bac.seq.rel.pstr, detection = 0.0001, prevalence = .97)
pstr.core.taxa <- tax_table(pstr.core)
View(as.data.frame(pstr.core.taxa))
pstr.core.melt <- psmelt(pstr.core)
pstr.core.melt$top.group <- "core"
write.csv(pstr.core.melt, "stats/pstr_core.csv")

##Plotting
#check # of OTUs
p.pstr <- ggplot(pstr.core.melt, aes(x = Sample, y = Genus, size = Abundance)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2","indianred3")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.pstr
print(p.pstr)
ggsave("Figures/pstr_core_bubble.pdf")

```


Bar plots
```{r}

Bac.phy <- Bac.seq.rel %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
Bac.phy.melt <- psmelt(Bac.phy)
Bac.phy.melt$code<-paste(Bac.phy.melt$treatment, Bac.phy.melt$time.point)
Bac.phy.melt$code <- factor(Bac.phy.melt$code, levels = c("control initial","control final","disease final"))

nb.cols <- 
mycolors <- colorRampPalette(brewer.pal(11, "RdYlBu"))(nb.cols)
library(qualpalr)

pal = qualpal(48, colorspace=list(h=c(13,350), s=c(0.3,1), l=c(0.2,0.8)))

# Generate a palette with 50 unique and different colors
library(colorspace)
palette <- diverging_hcl(50)

library(viridis)

# Generate a palette with 50 unique and easily distinguishable colors
palette <- viridis_pal(option = "C")(50)


#plot all (impossible to see)
ggplot(Bac.phy.melt, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
          scale_color_manual(values=pal$hex)+
  ylab("Relative Abundance") +
  xlab("location") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)+
   facet_wrap(~ species+time.point))
```



#plot by species at Phylum
```{r}
#cnat
Bac.seq.rel.cnat<-subset_samples(Bac.seq.rel, species=="Colpophyllia natans")
Bac.seq.rel.cnat.sd <- as(sample_data(Bac.seq.rel.cnat), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.cnat) > 0, Bac.seq.rel.cnat) #this removes any OTU with 0s

Bac.phy.cnat <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.cnat <- psmelt(Bac.phy.cnat)
  Bac.phy.melt.cnat$code<-paste(Bac.phy.melt.cnat$treatment, Bac.phy.melt.cnat$time.point)
  Bac.phy.melt.cnat$code <- factor(Bac.phy.melt.cnat$code, levels = c("control initial","control final","disease final"))

  ggplot(Bac.phy.melt.cnat, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("C. natans Phylum") +  # Add plot title here
   facet_wrap(~ code, ncol=1, scales = "free_x")

#pstr
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel, species=="Pseudodiploria strigosa")
Bac.seq.rel.pstr.sd <- as(sample_data(Bac.seq.rel.pstr), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.pstr) > 0, Bac.seq.rel.pstr) #this removes any OTU with 0s

Bac.phy.pstr <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr <- psmelt(Bac.phy.pstr)
  Bac.phy.melt.pstr$code<-paste(Bac.phy.melt.pstr$treatment, Bac.phy.melt.pstr$time.point)
  Bac.phy.melt.pstr$code <- factor(Bac.phy.melt.pstr$code, levels = c("control initial","control final","disease final"))

  ggplot(Bac.phy.melt.pstr, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Phylum") +  # Add plot title here
   facet_wrap(~ code, ncol=1, scales = "free_x")

#dlab
Bac.seq.rel.dlab<-subset_samples(Bac.seq.rel, species=="Diploria labyrinthiformis")
Bac.seq.rel.dlab<-subset_samples(Bac.seq.rel.dlab, time.point=="initial")
Bac.seq.rel.dlab.sd <- as(sample_data(Bac.seq.rel.dlab), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.dlab) > 0, Bac.seq.rel.dlab) #this removes any OTU with 0s

Bac.phy.dlab <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.dlab <- psmelt(Bac.phy.dlab)
  Bac.phy.melt.dlab$code<-paste(Bac.phy.melt.dlab$treatment, Bac.phy.melt.dlab$time.point)
  Bac.phy.melt.dlab$code <- factor(Bac.phy.melt.dlab$code, levels = c("control initial","control final","disease final"))

 g<- ggplot(Bac.phy.melt.dlab, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("D. labyrinthiformis Phylum") #+  # Add plot title here
   #facet_wrap(~ code, ncol=1, scales = "free_x")
ggsave("Figures/dlab_ini_phy.pdf", plot = g, width =33, height = 6) 

  Bac.phy.dlab <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.dlab <- psmelt(Bac.phy.dlab)
  Bac.phy.melt.dlab$code<-paste(Bac.phy.melt.dlab$treatment, Bac.phy.melt.dlab$time.point)
  Bac.phy.melt.dlab$code <- factor(Bac.phy.melt.dlab$code, levels = c("control initial","control final","disease final"))

 f<- ggplot(Bac.phy.melt.dlab, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("D. labyrinthiformis Family") #+  # Add plot title here
   #facet_wrap(~ code, ncol=1, scales = "free_x")
ggsave("Figures/dlab_ini_fam2.pdf", plot = f, width = 8, height = 6) 


#pster
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel, species=="Pseudodiploria strigosa")
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel.pstr, time.point=="initial")

Bac.seq.rel.pstr.sd <- as(sample_data(Bac.seq.rel.pstr), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.pstr) > 0, Bac.seq.rel.pstr) #this removes any OTU with 0s

Bac.phy.pstr <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr <- psmelt(Bac.phy.pstr)
  Bac.phy.melt.pstr$code<-paste(Bac.phy.melt.pstr$treatment, Bac.phy.melt.pstr$time.point)


 g<- ggplot(Bac.phy.melt.pstr, aes(x = sample_name, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Phylum") #+  # Add plot title here
   #facet_wrap(~ code, ncol=1, scales = "free_x")
ggsave("Figures/pstr_ini_phy.pdf", plot = g, width =33, height = 6) 

  Bac.phy.pstr <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr <- psmelt(Bac.phy.pstr)
  Bac.phy.melt.pstr$code<-paste(Bac.phy.melt.pstr$treatment, Bac.phy.melt.pstr$time.point)
  Bac.phy.melt.pstr$code <- factor(Bac.phy.melt.pstr$code, levels = c("control initial","control final","disease final"))

 f<- ggplot(Bac.phy.melt.pstr, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Family") #+  # Add plot title here
   #facet_wrap(~ code, ncol=1, scales = "free_x")
ggsave("Figures/pstr_ini_fam2.pdf", plot = f, width = 8, height = 6) 

```

#plot by species at Family
```{r}
#cnat

Bac.phy.cnat <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.cnat <- psmelt(Bac.phy.cnat)
  Bac.phy.melt.cnat$code<-paste(Bac.phy.melt.cnat$treatment, Bac.phy.melt.cnat$time.point)
  Bac.phy.melt.cnat$code <- factor(Bac.phy.melt.cnat$code, levels = c("control initial","control final","disease final"))

  ggplot(Bac.phy.melt.cnat, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  #scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("C. natans Phylum") +  # Add plot title here
   facet_wrap(~ code, ncol=1, scales = "free_x")

#pstr
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel, species=="Pseudodiploria strigosa")
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel.pstr, time.point=="initial")

Bac.seq.rel.pstr.sd <- as(sample_data(Bac.seq.rel.pstr), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.pstr) > 0, Bac.seq.rel.pstr) #this removes any OTU with 0s

Bac.phy.pstr <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr <- psmelt(Bac.phy.pstr)
  Bac.phy.melt.pstr$code<-paste(Bac.phy.melt.pstr$treatment, Bac.phy.melt.pstr$time.point)
  Bac.phy.melt.pstr$code <- factor(Bac.phy.melt.pstr$code, levels = c("control initial","control final","disease final"))

  ggplot(Bac.phy.melt.pstr, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("P. strigosa Phylum") +  # Add plot title here
   facet_wrap(~ code, ncol=1, scales = "free_x")

#dlab
Bac.seq.rel.dlab<-subset_samples(Bac.seq.rel, species=="Diploria labyrinthiformis")
Bac.seq.rel.dlab.sd <- as(sample_data(Bac.seq.rel.dlab), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel.dlab) > 0, Bac.seq.rel.dlab) #this removes any OTU with 0s

Bac.phy.dlab <- data.Bac.seq.rel %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.dlab <- psmelt(Bac.phy.dlab)
  Bac.phy.melt.dlab$code<-paste(Bac.phy.melt.dlab$treatment, Bac.phy.melt.dlab$time.point)
  Bac.phy.melt.dlab$code <- factor(Bac.phy.melt.dlab$code, levels = c("control initial","control final","disease final"))

  ggplot(Bac.phy.melt.dlab, aes(x = sample_name, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  #scale_fill_manual(values=pal) +
  #scale_color_manual(values=pal$hex)+
  scale_fill_manual(values = palette) +  # Use scale_fill_manual() for filling bars
  ylab("Relative Abundance") +
  xlab("individual") +
#  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
    ggtitle("D. labyrinthiformis Phylum") +  # Add plot title here
   facet_wrap(~ code, ncol=1, scales = "free_x")




```



#AH keep???
```{r}
dat <- Bac.seq.rel %>% tax_glom(taxrank = "Phylum") %>% psmelt()
head(dat)

dat$code<-paste(dat$treatment, dat$time.point)

df<-dat %>% 
  group_by(code, Phylum) %>% 
  summarise(TotalAbundance=sum(Abundance))%>% #calculate total abundance of each phylum
  group_by(code) %>%
  mutate(PercRelAbundance=TotalAbundance/sum(TotalAbundance)*100) %>%#calculate relative abundance
  dplyr::select(!TotalAbundance) 

df$Phylum <- gsub('[^[:alnum:] ]','',df$Phylum)

#change to a matrix with phylum in rows and lifestage in columns
df<-df%>%
  spread(key=Phylum, value=PercRelAbundance)
#replace na with 0, since 0 abundance was calculated as na in step above b/c dividing by 0
df[is.na(df)] <- 0
rownames(df)<-df$code
location_list<-df$code
dim(df)
df<-as.matrix(df)
df<-df[,-1]
taxa_list<-colnames(df)
df_mat <- matrix(as.numeric(df),    # Convert to numeric matrix
                  ncol = ncol(df))                         # Print numeric matrix
colnames(df_mat)<-taxa_list
rownames(df_mat)<-location_list
df_mat<-t(df_mat)



#Heat map
#cnat
  library(ComplexHeatmap)
row_dend = dendsort(hclust(dist(df_mat)))
col_dend = dendsort(hclust(dist(t(df_mat))))
col_fun = colorRamp2(c(0, 50, 100), c("white", "darkgray", "navy"))
pdf(file = "16S-Phylum-Heatmap.pdf", height = 8, width = 18)
ComplexHeatmap::Heatmap(df_mat, name = "Rel. Abun. (%)", row_title = "", column_title = "16S Relative Abundance (Phylum)", 
        col = col_fun, 
        row_names_side = "left", 
        row_dend_side = "right",
        width = unit(4, "in"), 
        height = unit(4, "in"), 
        column_dend_height = unit(.5, "in"),
        row_dend_width = unit(.5, "in"),
        column_dend_reorder = FALSE,
        row_dend_reorder = TRUE,
        row_gap = unit(2.5, "mm"),
        clustering_distance_rows = "euclidean",
        clustering_method_rows = "complete",
        border = TRUE, 
        column_names_gp =  gpar(fontsize = 12, border=FALSE),
        column_names_rot = 35,
        cluster_rows = row_dend, 
        #cluster_columns = col_dend,
        column_order = loc_order, 
        row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE))
dev.off()

plot_bar(Bac.phy.dlab, fill = "Phylum")+theme(legend.position="bottom")
```

#### Final time point by species
#C. natans
```{r}
Bac.seq.cnat.f<-subset_samples(Bac.seq.cnat, time.point== "final")
Bac.seq.cnat.f = prune_taxa(taxa_sums(Bac.seq.cnat.f) > 0, Bac.seq.cnat.f) #this removes any OTU with 0s

Bac.seq.cnat.f.sd <- as(sample_data(Bac.seq.cnat.f), "data.frame") #look at samp data

#make unifrac matrix
Bac.seq.wu.cnat.f <- phyloseq::distance(Bac.seq.cnat.f, method = "wunifrac")
s.u.samp.cnat.f.df <- as(sample_data(Bac.seq.cnat.f), "data.frame") #sample df

#adonixs test between sample types: p=
set.seed(30)
adonis2(Bac.seq.wu.cnat.f ~ treatment, data = Bac.seq.cnat.f.sd)

# Homogeneity of dispersion test  
    set.seed(30) 
    permutest(betadisper(Bac.seq.wu.cnat.f, s.u.samp.cnat.f.df$treatment, type = "centroid"))
  ball<-  betadisper(Bac.seq.wu.cnat.f, s.u.samp.cnat.f.df$code, type = "centroid")
  TukeyHSD(ball,  ordered = FALSE,conf.level = 0.95)

#plot

##### NMDS ####
unifrac.cnat.f <- ordinate(Bac.seq.cnat.f, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.cnat.f)
print(unifrac.cnat.f)# stress score .172
scores.ord.u_RelA_stats.cnat<-as.data.frame(cbind(vegan::scores(unifrac.cnat.f, display="sites")))  
     Bac.seq.cnat.f.sd <- as(sample_data(Bac.seq.cnat.f), "data.frame") #sample df

scores.ord.u_RelA_stats.cnat$treatment <- Bac.seq.cnat.f.sd$treatment

p<-ggplot(scores.ord.u_RelA_stats.cnat, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = treatment), size = 4) +
    scale_color_manual(values=c("turquoise3","orange"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = treatment), linetype = 2) +
  ggtitle(expression(italic("C. natans") * " microbiome NMDS")) +
  theme_classic();p
ggsave("Figures/cnat.final_NMDS.pdf", plot = p, width = 8, height = 6) 

#bar plot FAMILY ####
#family
Bac.fam.cnat <- Bac.seq.cnat.f %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.cnat <- psmelt(Bac.fam.cnat)
Bac.fam.melt.cnat$treatment_sample <- paste(Bac.fam.melt.cnat$treatment, Bac.fam.melt.cnat$sample_name, sep = "_")

#plot individual samples
p<-  ggplot(Bac.fam.melt.cnat, aes(x = treatment_sample, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("C. natans") ~ "by Family"));p
ggsave("Figures/cnat.final.bar.all.pdf", plot = p, width = 8, height = 6) 



#plot by treatment group relabund  
 # Calculate the total abundance for each treatment group
Bac.fam.melt.cnat2 <- Bac.fam.melt.cnat %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.fam.melt.cnat2 <- Bac.fam.melt.cnat2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.fam.melt.cnat2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.fam.melt.cnat2, aes(x = treatment, y = relative_abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("C. natans") ~ "by Family"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/cnat.final.bar.fam.treat.png", plot = p, width = 33, height = 6) 

#bar plot PHYLUM ####
#phy
Bac.phy.cnat.p <- Bac.seq.cnat.f %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.cnat.p <- psmelt(Bac.phy.cnat.p)
Bac.phy.melt.cnat.p$treatment_sample <- paste(Bac.phy.melt.cnat.p$treatment, Bac.phy.melt.cnat.p$sample_name, sep = "_")

p<-  ggplot(Bac.phy.melt.cnat.p, aes(x = treatment_sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("C. natans") ~ "by Phylum"));p
ggsave("Figures/cnat.final.bar.all.phy.pdf", plot = p, width = 8, height = 6) 

#plot by treatment group relabund

 # Calculate the total abundance for each treatment group
Bac.phy.melt.cnat.p2 <- Bac.phy.melt.cnat.p %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.phy.melt.cnat2 <- Bac.phy.melt.cnat.p2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.phy.melt.cnat2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.phy.melt.cnat2, aes(x = treatment, y = relative_abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("C. natans") ~ "by Phylum"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/cnat.final.bar.treat.pdf", plot = p, width = 19, height = 8) 

  
  ### HE from ACE
  
##Core Analysis ####
cnat.core <- core(Bac.seq.cnat.f, detection = 0.0001, prevalence = .90)
cnat.core.taxa <- tax_table(cnat.core)
View(as.data.frame(cnat.core.taxa))

#cnat
#cnat <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#cnat.ra <- transform_sample_counts(cnat, function(x) x/ sum(x))

#cnat.core <- core(Bac.seq.cnat.f, detection = 0.0001, prevalence = .70)
#cnat.core.taxa <- tax_table(cnat.core)
#View(as.data.frame(cnat.core.taxa))
cnat.core.melt <- psmelt(cnat.core)
cnat.core.melt$top.group <- "core"
#write.csv(cnat.core.melt, "stats/cnat_core.csv")

##Plotting
#check # of OTUs
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

p.cnat <- ggplot(cnat.core.melt, aes(x = treatment, y = Genus, size = Abundance, color=treatment)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2","indianred3")) +
        scale_x_discrete(labels = custom_labels)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.cnat
print(p.cnat)
ggsave("Figures/cnat_core_bubble.pdf")



#### venn ####
##Can we draw a venn diagram?
library(tidyverse)
amur.core.melt.con<-subset(cnat.core.melt, treatment=="control")
amur.core.melt.con <- amur.core.melt.con %>% unite(OTU, Genus, col='otu_genus',sep='-')
amur.core.melt.con.list <- unique(amur.core.melt.con$otu_genus)

amur.core.melt.SCTLD<-subset(cnat.core.melt, treatment=="disease")
amur.core.melt.SCTLD <- amur.core.melt.SCTLD %>% unite(OTU, Genus, col='otu_genus',sep='-')
amur.core.melt.SCTLD.list <- unique(amur.core.melt.SCTLD$otu_genus)

candidates <- list("Control"=amur.core.melt.con.list,"SCTLD-Exposed"=amur.core.melt.SCTLD.list)

library(VennDiagram)

# To plot to the current device
grid.newpage()
draw.pairwise.venn(
  area1 = length(amur.core.melt.con.list),
  area2 = length(amur.core.melt.SCTLD.list),
  cross.area = length(intersect(amur.core.melt.con.list, amur.core.melt.SCTLD.list)),
  category = c("Control", "SCTLD-Exposed"),
  fill = c("#E69F00", "#56B4E9"),
  alpha = 0.5
)

#TOP OTUS not just top taxa  ####
# Selecting top 10 OTUs

#control
Bac.seq.cnat.f.control<-subset_samples(Bac.seq.cnat.f, treatment=="control")
TopNOTUsCnat.cont = names(sort(taxa_sums(Bac.seq.cnat.f.control), TRUE)[1:10])
cnat.abund.cont = prune_taxa(TopNOTUsCnat.cont, Bac.seq.cnat.f.control)
cnat.abund.melt.cont <- psmelt(cnat.abund.cont)
cnat.abund.melt.cont$top.group <- "abund"

#SCTLD-Exposed 
Bac.seq.cnat.f.disease<-subset_samples(Bac.seq.cnat.f, treatment=="disease")
TopNOTUsCnat.dis = names(sort(taxa_sums(Bac.seq.cnat.f.disease), TRUE)[1:10])
cnat.abund.dis = prune_taxa(TopNOTUsCnat.dis, Bac.seq.cnat.f.disease)
cnat.abund.melt.dis <- psmelt(cnat.abund.dis)
cnat.abund.melt.dis$top.group <- "abund"


##Venn Diagram 
cont.list <- unique(cnat.abund.melt.cont$Genus)
disease.list <- unique(cnat.abund.melt.dis$Genus)

candidates <- list("Control" = cont.list, "SCTLD-Exposed" = disease.list)
library(VennDiagram)
venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#E69F00", "#56B4E9"), alpha = 0.5)
pdf(file = "Figures/venn_abund_cnat.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("Control SCTLD-Exposed", "Control", "SCTLD-Exposed")
View(overlap)

#Elements in both Set1 and Set2
both <- intersect(cont.list, disease.list)

# Elements only in Set1
only_set1 <- setdiff(cont.list, disease.list)

# Elements only in Set2
only_set2 <- setdiff(disease.list,cont.list)

# Print results
print(both)
print(only_set1)
print(only_set2)


### Alpha diversity ####
#Bac.seq.S.raw


Bac.seq.raw.cnat<-subset_samples(Bac.seq.S.raw, species=="Colpophyllia natans")
Bac.seq.raw.cnat<-subset_samples(Bac.seq.raw.cnat, time.point=="final")

Bac.seq.raw.cnat = prune_taxa(taxa_sums(Bac.seq.raw.cnat) > 0, Bac.seq.raw.cnat) 
Bac.seq.raw.cnat.sd <- as(sample_data(Bac.seq.raw.cnat), "data.frame") #sample df

#make unifrac matrix
Bac.seq.wu.ini <- phyloseq::distance(Bac.seq.raw.cnat, method = "wunifrac")
s.u.samp.df.ini <- as(sample_data(Bac.seq.raw.cnat), "data.frame") #sample df
s.u.samp.df.ini$treatment<-as.factor(s.u.samp.df.ini$treatment)
  
# pull out: observed, diversity_shannon, evenness_pielou
erich.tab.obs <-microbiome::alpha(Bac.seq.raw.cnat, index = "observed") 
  erich.tab.obs$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
    erich.tab.obs$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.shan <-microbiome::alpha(Bac.seq.raw.cnat, index = "diversity_shannon")
    erich.tab.shan$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.even <-microbiome::alpha(Bac.seq.raw.cnat, index = "evenness_pielou")
    erich.tab.even$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

alpha<-merge(erich.tab.obs, erich.tab.even, by.all="sample_name")
alpha<-merge(alpha, erich.tab.shan, by="sample_name")
#write.csv(erich.tab.obs, "erich.tab.obs.csv")
#add meta
alpha<-merge(alpha, s.u.samp.df.ini, by.x="sample_name")

#shannon ####
  hist(alpha$diversity_shannon)
  set.seed(30)
  aov.shannon = aov(diversity_shannon ~ treatment, data=alpha)
    summary(aov.shannon) 
    
#means
shannon_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(diversity_shannon[!is.na(diversity_shannon)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(diversity_shannon, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(diversity_shannon, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(diversity_shannon, na.rm=TRUE) #calculate max, could also calculate min () if desired
);shannon_mean

#set colors
custom_colors <- c("disease" = "#E69F00", "control" = "#56B4E9")  
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels


shannon_plot<-ggplot(data=shannon_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Shannon Diversity"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("C. natans") ~ "- Shannon diversity"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));shannon_plot
ggsave("Figures/cnat_shannon.pdf", shannon_plot)

#Richness ####
  hist(alpha$observed)
  set.seed(30)
  aov.observed = aov(observed ~ treatment, data=alpha)
    summary(aov.observed) # away p=0.038
    
#means
observed_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(observed[!is.na(observed)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(observed, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(observed, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(observed, na.rm=TRUE) #calculate max, could also calculate min () if desired
);observed_mean

rich_plot<-ggplot(data=observed_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Richness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("C. natans") ~ "- Richness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));rich_plot
ggsave("Figures/cnat_rich.pdf", rich_plot)


#evenness ####
  hist(alpha$evenness_pielou)
  set.seed(30)
  aov.evenness = aov(evenness_pielou ~ treatment, data=alpha)
    summary(aov.evenness) # home p<0.001, away p<0.001, genet p<0.001, home*away p<0.001
    
#means
evenness_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
);evenness_mean

even_plot<-ggplot(data=evenness_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Evenness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("C. natans") ~ "- Evenness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));even_plot
ggsave("Figures/cnat_even.pdf", even_plot)

library(grid)

g<-grid.arrange(rich_plot, even_plot, shannon_plot, nrow = 1,ncol=3)
            # widths = c(1, 1, 1),  # Adjust widths as needed
            # heights = c(3),       # Adjust heights as needed
           #  asp = 1)              # Set aspect ratio
ggsave("Figures/cnat_alpha.pdf", g)



```

#D. lab 
Diploria labyrinthiformis
```{r}
Bac.seq.dlab.f<-subset_samples(Bac.seq.dlab, time.point== "final")
Bac.seq.dlab.f = prune_taxa(taxa_sums(Bac.seq.dlab.f) > 0, Bac.seq.dlab.f) #this removes any OTU with 0s

Bac.seq.dlab.f.sd <- as(sample_data(Bac.seq.dlab.f), "data.frame") #look at samp data

#make unifrac matrix
Bac.seq.wu.dlab.f <- phyloseq::distance(Bac.seq.dlab.f, method = "wunifrac")
s.u.samp.dlab.f.df <- as(sample_data(Bac.seq.dlab.f), "data.frame") #sample df

#adonixs test between sample types: p=
set.seed(30)
adonis2(Bac.seq.wu.dlab.f ~ treatment, data = Bac.seq.dlab.f.sd)

# Homogeneity of dispersion test  
    set.seed(30) 
    permutest(betadisper(Bac.seq.wu.dlab.f, s.u.samp.dlab.f.df$treatment, type = "centroid"))
  ball<-  betadisper(Bac.seq.wu.dlab.f, s.u.samp.dlab.f.df$code, type = "centroid")
  TukeyHSD(ball,  ordered = FALSE,conf.level = 0.95)

#plot

##### NMDS ####
unifrac.dlab.f <- ordinate(Bac.seq.dlab.f, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.dlab.f)
print(unifrac.dlab.f)# stress score .172
scores.ord.u_RelA_stats.dlab<-as.data.frame(cbind(vegan::scores(unifrac.dlab.f, display="sites")))  
     Bac.seq.dlab.f.sd <- as(sample_data(Bac.seq.dlab.f), "data.frame") #sample df

scores.ord.u_RelA_stats.dlab$treatment <- Bac.seq.dlab.f.sd$treatment

p<-ggplot(scores.ord.u_RelA_stats.dlab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = treatment), size = 4) +
    scale_color_manual(values=c("turquoise3","orange"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = treatment), linetype = 2) +
  ggtitle(expression(italic("D. labyrinthiformis") * " microbiome NMDS")) +
  theme_classic();p
ggsave("Figures/dlab.final_NMDS.pdf", plot = p, width = 8, height = 6) 

#bar plot FAMILY ####
#family
Bac.fam.dlab <- Bac.seq.dlab.f %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.dlab <- psmelt(Bac.fam.dlab)
Bac.fam.melt.dlab$treatment_sample <- paste(Bac.fam.melt.dlab$treatment, Bac.fam.melt.dlab$sample_name, sep = "_")

#plot individual samples
p<-  ggplot(Bac.fam.melt.dlab, aes(x = treatment_sample, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("D. labyrinthiformis") ~ "by Family"));p
ggsave("Figures/dlab.final.bar.fam.all.pdf", plot = p, width = 8, height = 6) 



#plot by treatment group relabund  
 # Calculate the total abundance for each treatment group
Bac.fam.melt.dlab2 <- Bac.fam.melt.dlab %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.fam.melt.dlab2 <- Bac.fam.melt.dlab2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.fam.melt.dlab2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.fam.melt.dlab2, aes(x = treatment, y = relative_abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("D. labyrinthiformis") ~ "by Family"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/dlab.final.bar.fam.treat.pdf", plot = p, width = 8, height = 6) 

#bar plot PHYLUM ####
#phy
Bac.phy.dlab.p <- Bac.seq.dlab.f %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.dlab.p <- psmelt(Bac.phy.dlab.p)
Bac.phy.melt.dlab.p$treatment_sample <- paste(Bac.phy.melt.dlab.p$treatment, Bac.phy.melt.dlab.p$sample_name, sep = "_")

p<-  ggplot(Bac.phy.melt.dlab.p, aes(x = treatment_sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("D. labyrinthiformis") ~ "by Phylum"));p
ggsave("Figures/dlab.final.bar.all.phy.pdf", plot = p, width = 8, height = 6) 

#plot by treatment group relabund

 # Calculate the total abundance for each treatment group
Bac.phy.melt.dlab.p2 <- Bac.phy.melt.dlab.p %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.phy.melt.dlab2 <- Bac.phy.melt.dlab.p2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.phy.melt.dlab2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.phy.melt.dlab2, aes(x = treatment, y = relative_abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("D. labyrinthiformis") ~ "by Phylum"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/dlab.final.bar.treat.pdf", plot = p, width = 19, height = 8) 

  
  ### HE from ACE
  
##Core Analysis ####
dlab.core <- core(Bac.seq.dlab.f, detection = 0.0001, prevalence = .90)
dlab.core.taxa <- tax_table(dlab.core)
View(as.data.frame(dlab.core.taxa))

#dlab
#dlab <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#dlab.ra <- transform_sample_counts(dlab, function(x) x/ sum(x))

#dlab.core <- core(Bac.seq.dlab.f, detection = 0.0001, prevalence = .70)
#dlab.core.taxa <- tax_table(dlab.core)
#View(as.data.frame(dlab.core.taxa))
dlab.core.melt <- psmelt(dlab.core)
dlab.core.melt$top.group <- "core"
write.csv(dlab.core.melt, "stats/dlab_core.csv")

##Plotting
#check # of OTUs
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

p.dlab <- ggplot(dlab.core.melt, aes(x = treatment, y = Genus, size = Abundance, color=treatment)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2")) +
        scale_x_discrete(labels = custom_labels)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.dlab
ggsave("Figures/dlab_core_bubble.pdf",p.dlab)



#### venn ####
##Can we draw a venn diagram?
library(tidyverse)
amur.core.melt.con<-subset(dlab.core.melt, treatment=="control")
amur.core.melt.con <- amur.core.melt.con %>% unite(OTU, Genus, col='otu_genus',sep='-')
amur.core.melt.con.list <- unique(amur.core.melt.con$otu_genus)

amur.core.melt.SCTLD<-subset(dlab.core.melt, treatment=="disease")
amur.core.melt.SCTLD <- amur.core.melt.SCTLD %>% unite(OTU, Genus, col='otu_genus',sep='-')
amur.core.melt.SCTLD.list <- unique(amur.core.melt.SCTLD$otu_genus)

candidates <- list("Control"=amur.core.melt.con.list,"SCTLD-Exposed"=amur.core.melt.SCTLD.list)

library(VennDiagram)

# To plot to the current device
grid.newpage()
draw.pairwise.venn(
  area1 = length(amur.core.melt.con.list),
  area2 = length(amur.core.melt.SCTLD.list),
  cross.area = length(intersect(amur.core.melt.con.list, amur.core.melt.SCTLD.list)),
  category = c("Control", "SCTLD-Exposed"),
  fill = c("#E69F00", "#56B4E9"),
  alpha = 0.5
)




venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#E69F00", "#56B4E9"), alpha = 0.5)
pdf(file = "..Figure/venn_core_dlab.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("mcap pcomp pvar pacu", "mcap pcomp pvar", "mcap pcomp pacu", "mcap pvar pacu", "pcomp pvar pacu", "mcap pcomp", "mcap pvar ", 
                    "mcap pacu", "pcomp pvar", "pcomp  pacu", "pvar pacu", "mcap", "pcomp", "pvar", "pacu")
View(overlap)



#TOP OTUS not just top taxa  ####
# Selecting top 10 OTUs

#control
Bac.seq.dlab.f.control<-subset_samples(Bac.seq.dlab.f, treatment=="control")
TopNOTUsdlab.cont = names(sort(taxa_sums(Bac.seq.dlab.f.control), TRUE)[1:10])
dlab.abund.cont = prune_taxa(TopNOTUsdlab.cont, Bac.seq.dlab.f.control)
dlab.abund.melt.cont <- psmelt(dlab.abund.cont)
dlab.abund.melt.cont$top.group <- "abund"

#SCTLD-Exposed 
Bac.seq.dlab.f.disease<-subset_samples(Bac.seq.dlab.f, treatment=="disease")
TopNOTUsdlab.dis = names(sort(taxa_sums(Bac.seq.dlab.f.disease), TRUE)[1:10])
dlab.abund.dis = prune_taxa(TopNOTUsdlab.dis, Bac.seq.dlab.f.disease)
dlab.abund.melt.dis <- psmelt(dlab.abund.dis)
dlab.abund.melt.dis$top.group <- "abund"


##Venn Diagram 
cont.list <- unique(dlab.abund.melt.cont$Genus)
disease.list <- unique(dlab.abund.melt.dis$Genus)

candidates <- list("Control" = cont.list, "SCTLD-Exposed" = disease.list)
library(VennDiagram)
venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#56B4E9","#E69F00"), alpha = 0.5)
pdf(file = "Figures/venn_abund_dlab.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("Control SCTLD-Exposed", "Control", "SCTLD-Exposed")
View(overlap)

#Elements in both Set1 and Set2
both <- intersect(cont.list, disease.list)

# Elements only in Set1
only_set1 <- setdiff(cont.list, disease.list)

# Elements only in Set2
only_set2 <- setdiff(disease.list,cont.list)

# Print results
print(both)
print(only_set1)
print(only_set2)


### Alpha diversity ####
#Bac.seq.S.raw


Bac.seq.raw.dlab<-subset_samples(Bac.seq.S.raw, species=="Diploria labyrinthiformis")
Bac.seq.raw.dlab<-subset_samples(Bac.seq.raw.dlab, time.point=="final")

Bac.seq.raw.dlab = prune_taxa(taxa_sums(Bac.seq.raw.dlab) > 0, Bac.seq.raw.dlab) 
Bac.seq.raw.dlab.sd <- as(sample_data(Bac.seq.raw.dlab), "data.frame") #sample df

#make unifrac matrix
Bac.seq.wu.ini <- phyloseq::distance(Bac.seq.raw.dlab, method = "wunifrac")
s.u.samp.df.ini <- as(sample_data(Bac.seq.raw.dlab), "data.frame") #sample df
s.u.samp.df.ini$treatment<-as.factor(s.u.samp.df.ini$treatment)
  
# pull out: observed, diversity_shannon, evenness_pielou
erich.tab.obs <-microbiome::alpha(Bac.seq.raw.dlab, index = "observed") 
  erich.tab.obs$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
    erich.tab.obs$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.shan <-microbiome::alpha(Bac.seq.raw.dlab, index = "diversity_shannon")
    erich.tab.shan$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.even <-microbiome::alpha(Bac.seq.raw.dlab, index = "evenness_pielou")
    erich.tab.even$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

alpha<-merge(erich.tab.obs, erich.tab.even, by.all="sample_name")
alpha<-merge(alpha, erich.tab.shan, by="sample_name")
#write.csv(erich.tab.obs, "erich.tab.obs.csv")
#add meta
alpha<-merge(alpha, s.u.samp.df.ini, by.x="sample_name")

#shannon ####
  hist(alpha$diversity_shannon)
  set.seed(30)
  aov.shannon = aov(diversity_shannon ~ treatment, data=alpha)
    summary(aov.shannon) 
    
#means
shannon_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(diversity_shannon[!is.na(diversity_shannon)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(diversity_shannon, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(diversity_shannon, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(diversity_shannon, na.rm=TRUE) #calculate max, could also calculate min () if desired
);shannon_mean

#set colors
custom_colors <- c("disease" = "#E69F00", "control" = "#56B4E9")  
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels


shannon_plot<-ggplot(data=shannon_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Shannon Diversity"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("D. labyrinthiformis") ~ "- Shannon diversity"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));shannon_plot
ggsave("Figures/dlab_shannon.pdf", shannon_plot)

#Richness ####
  hist(alpha$observed)
  set.seed(30)
  aov.observed = aov(observed ~ treatment, data=alpha)
    summary(aov.observed) # away p=0.038
    
#means
observed_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(observed[!is.na(observed)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(observed, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(observed, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(observed, na.rm=TRUE) #calculate max, could also calculate min () if desired
);observed_mean

rich_plot<-ggplot(data=observed_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Richness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("D. labyrinthiformis") ~ "- Richness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));rich_plot
ggsave("Figures/dlab_rich.pdf", rich_plot)


#evenness ####
  hist(alpha$evenness_pielou)
  set.seed(30)
  aov.evenness = aov(evenness_pielou ~ treatment, data=alpha)
    summary(aov.evenness) # home p<0.001, away p<0.001, genet p<0.001, home*away p<0.001
    
#means
evenness_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
);evenness_mean

even_plot<-ggplot(data=evenness_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Evenness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("D. labyrinthiformis") ~ "- Evenness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));even_plot
ggsave("Figures/dlab_even.pdf", even_plot)

library(grid)

g<-grid.arrange(rich_plot, even_plot, shannon_plot, nrow = 1,ncol=3)
            # widths = c(1, 1, 1),  # Adjust widths as needed
            # heights = c(3),       # Adjust heights as needed
           #  asp = 1)              # Set aspect ratio
ggsave("Figures/dlab_alpha.pdf", g)

```


#P str.  
Pseudodiploria strigosa
```{r}
Bac.seq.rel.pstr<-subset_samples(Bac.seq.rel, species=="Pseudodiploria strigosa")
Bac.seq.rel.pstr = prune_taxa(taxa_sums(Bac.seq.rel.pstr) > 0, Bac.seq.rel.pstr) #this removes any OTU with 0s
Bac.seq.pstr.f<-subset_samples(Bac.seq.rel.pstr, time.point== "final")
Bac.seq.pstr.f = prune_taxa(taxa_sums(Bac.seq.pstr.f) > 0, Bac.seq.pstr.f) #this removes any OTU with 0s

Bac.seq.pstr.f.sd <- as(sample_data(Bac.seq.pstr.f), "data.frame") #look at samp data

#make unifrac matrix
Bac.seq.wu.pstr.f <- phyloseq::distance(Bac.seq.pstr.f, method = "wunifrac")
s.u.samp.pstr.f.df <- as(sample_data(Bac.seq.pstr.f), "data.frame") #sample df

#adonixs test between sample types: p=
set.seed(30)
adonis2(Bac.seq.wu.pstr.f ~ treatment, data = Bac.seq.pstr.f.sd)

# Homogeneity of dispersion test  
    set.seed(30) 
    permutest(betadisper(Bac.seq.wu.pstr.f, s.u.samp.pstr.f.df$treatment, type = "centroid"))
  ball<-  betadisper(Bac.seq.wu.pstr.f, s.u.samp.pstr.f.df$code, type = "centroid")
  TukeyHSD(ball,  ordered = FALSE,conf.level = 0.95)

#plot

##### NMDS ####
unifrac.pstr.f <- ordinate(Bac.seq.pstr.f, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.pstr.f)
print(unifrac.pstr.f)# stress score .172
scores.ord.u_RelA_stats.pstr<-as.data.frame(cbind(vegan::scores(unifrac.pstr.f, display="sites")))  
     Bac.seq.pstr.f.sd <- as(sample_data(Bac.seq.pstr.f), "data.frame") #sample df

scores.ord.u_RelA_stats.pstr$treatment <- Bac.seq.pstr.f.sd$treatment

p<-ggplot(scores.ord.u_RelA_stats.pstr, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = treatment), size = 4) +
    scale_color_manual(values=c("turquoise3","orange"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = treatment), linetype = 2) +
  ggtitle(expression(italic("P. strigosa") * " microbiome NMDS")) +
  theme_classic();p
ggsave("Figures/pstr.final_NMDS.pdf", plot = p, width = 8, height = 6) 

#bar plot FAMILY ####
#family
Bac.fam.pstr <- Bac.seq.pstr.f %>% 
  tax_glom(taxrank = "Family", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.fam.melt.pstr <- psmelt(Bac.fam.pstr)
Bac.fam.melt.pstr$treatment_sample <- paste(Bac.fam.melt.pstr$treatment, Bac.fam.melt.pstr$sample_name, sep = "_")

#plot individual samples
p<-  ggplot(Bac.fam.melt.pstr, aes(x = treatment_sample, y = Abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("P. strigosa") ~ "by Family"));p
ggsave("Figures/pstr.final.bar.fam.all2.pdf", plot = p, width = 38, height = 6) 



#plot by treatment group relabund  
 # Calculate the total abundance for each treatment group
Bac.fam.melt.pstr2 <- Bac.fam.melt.pstr %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.fam.melt.pstr2 <- Bac.fam.melt.pstr2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.fam.melt.pstr2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.fam.melt.pstr2, aes(x = treatment, y = relative_abundance, fill = Family)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("P. strigosa") ~ "by Family"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/pstr.final.bar.fam.treat.pdf", plot = p, width = 8, height = 6) 

#bar plot PHYLUM ####
#phy
Bac.phy.pstr.p <- Bac.seq.pstr.f %>% 
  tax_glom(taxrank = "Phylum", NArm = FALSE) %>% 
  transform_sample_counts(function(x) {x/sum(x)} ) 
  Bac.phy.melt.pstr.p <- psmelt(Bac.phy.pstr.p)
Bac.phy.melt.pstr.p$treatment_sample <- paste(Bac.phy.melt.pstr.p$treatment, Bac.phy.melt.pstr.p$sample_name, sep = "_")

p<-  ggplot(Bac.phy.melt.pstr.p, aes(x = treatment_sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  xlab("individual") +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("P. strigosa") ~ "by Phylum"));p
ggsave("Figures/pstr.final.bar.all.phy.pdf", plot = p, width = 8, height = 6) 

#plot by treatment group relabund

 # Calculate the total abundance for each treatment group
Bac.phy.melt.pstr.p2 <- Bac.phy.melt.pstr.p %>%
  group_by(treatment) %>%
  mutate(total_abundance = sum(Abundance))

# Calculate the relative abundance
Bac.phy.melt.pstr2 <- Bac.phy.melt.pstr.p2 %>%
  mutate(relative_abundance = Abundance / total_abundance)

# Check the updated data frame
head(Bac.phy.melt.pstr2)

custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

 p<- ggplot(Bac.phy.melt.pstr2, aes(x = treatment, y = relative_abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  ylab("Relative Abundance") +
  #theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+  
  ggtitle(expression(italic("P. strigosa") ~ "by Phylum"))+
      scale_x_discrete(labels = custom_labels)+
theme(
    panel.background = element_blank(),  # Remove background color
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(colour = "black", fill = NA, size = 1)  # Add a black border around the plot
  );p
  ggsave("Figures/pstr.final.bar.treat.pdf", plot = p, width = 19, height = 8) 

  
  ### HE from ACE
  
##Core Analysis ####
pstr.core <- core(Bac.seq.pstr.f, detection = 0.0001, prevalence = .90)
pstr.core.taxa <- tax_table(pstr.core)
View(as.data.frame(pstr.core.taxa))

#pstr
#pstr <- subset_samples(Bac.seq.rel, species == "Colpophyllia natans")
#pstr.ra <- transform_sample_counts(pstr, function(x) x/ sum(x))

#pstr.core <- core(Bac.seq.pstr.f, detection = 0.0001, prevalence = .70)
#pstr.core.taxa <- tax_table(pstr.core)
#View(as.data.frame(pstr.core.taxa))
pstr.core.melt <- psmelt(pstr.core)
pstr.core.melt$top.group <- "core"
write.csv(pstr.core.melt, "stats/pstr_core.csv")

##Plotting
#check # of OTUs
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels

p.pstr <- ggplot(pstr.core.melt, aes(x = treatment, y = Genus, size = Abundance, color=treatment)) +
  geom_point() +
  scale_size_area(max_size = 6, breaks = c(0.05, 0.1, 0.3, 0.5, 0.7, 0.9 )) +
  coord_fixed(ratio = 0.9) +
  scale_color_manual(values=c("dodgerblue4", "darkorange2")) +
        scale_x_discrete(labels = custom_labels)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1));p.pstr
ggsave("Figures/pstr_core_bubble.pdf",p.pstr)



#### venn ####
##Can we draw a venn diagram?
library(tidyverse)
pstr.core.melt.con<-subset(pstr.core.melt, treatment=="control")
pstr.core.melt.con <- pstr.core.melt.con %>% unite(OTU, Genus, col='otu_genus',sep='-')
pstr.core.melt.con.list <- unique(pstr.core.melt.con$otu_genus)

pstr.core.melt.SCTLD<-subset(pstr.core.melt, treatment=="disease")
pstr.core.melt.SCTLD <- pstr.core.melt.SCTLD %>% unite(OTU, Genus, col='otu_genus',sep='-')
pstr.core.melt.SCTLD.list <- unique(pstr.core.melt.SCTLD$otu_genus)

candidates <- list("Control"=pstr.core.melt.con.list,"SCTLD-Exposed"=pstr.core.melt.SCTLD.list)

library(VennDiagram)

# To plot to the current device
grid.newpage()
draw.pairwise.venn(
  area1 = length(pstr.core.melt.con.list),
  area2 = length(pstr.core.melt.SCTLD.list),
  cross.area = length(intersect(pstr.core.melt.con.list, pstr.core.melt.SCTLD.list)),
  category = c("Control", "SCTLD-Exposed"),
  fill = c("#E69F00", "#56B4E9"),
  alpha = 0.5
)




venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#E69F00", "#56B4E9"), alpha = 0.5)
pdf(file = "..Figure/venn_core_pstr.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("mcap pcomp pvar pacu", "mcap pcomp pvar", "mcap pcomp pacu", "mcap pvar pacu", "pcomp pvar pacu", "mcap pcomp", "mcap pvar ", 
                    "mcap pacu", "pcomp pvar", "pcomp  pacu", "pvar pacu", "mcap", "pcomp", "pvar", "pacu")
View(overlap)



#TOP OTUS not just top taxa  ####
# Selecting top 10 OTUs

#control
Bac.seq.pstr.f.control<-subset_samples(Bac.seq.pstr.f, treatment=="control")
TopNOTUspstr.cont = names(sort(taxa_sums(Bac.seq.pstr.f.control), TRUE)[1:10])
pstr.abund.cont = prune_taxa(TopNOTUspstr.cont, Bac.seq.pstr.f.control)
pstr.abund.melt.cont <- psmelt(pstr.abund.cont)
pstr.abund.melt.cont$top.group <- "abund"

#SCTLD-Exposed 
Bac.seq.pstr.f.disease<-subset_samples(Bac.seq.pstr.f, treatment=="disease")
TopNOTUspstr.dis = names(sort(taxa_sums(Bac.seq.pstr.f.disease), TRUE)[1:10])
pstr.abund.dis = prune_taxa(TopNOTUspstr.dis, Bac.seq.pstr.f.disease)
pstr.abund.melt.dis <- psmelt(pstr.abund.dis)
pstr.abund.melt.dis$top.group <- "abund"


##Venn Diagram 
cont.list <- unique(pstr.abund.melt.cont$Genus)
disease.list <- unique(pstr.abund.melt.dis$Genus)

candidates <- list("Control" = cont.list, "SCTLD-Exposed" = disease.list)
library(VennDiagram)
venn <- venn.diagram(x = candidates, filename = NULL, fill = c("#56B4E9","#E69F00"), alpha = 0.5)
pdf(file = "Figures/venn_abund_pstr.pdf")
grid.draw(venn)
dev.off()
overlap <- calculate.overlap(candidates)
names(overlap) <- c("Control SCTLD-Exposed", "Control", "SCTLD-Exposed")
View(overlap)

#Elements in both Set1 and Set2
both <- intersect(cont.list, disease.list)

# Elements only in Set1
only_set1 <- setdiff(cont.list, disease.list)

# Elements only in Set2
only_set2 <- setdiff(disease.list,cont.list)

# Print results
print(both)
print(only_set1)
print(only_set2)


### Alpha diversity ####
#Bac.seq.S.raw


Bac.seq.raw.pstr<-subset_samples(Bac.seq.S.raw, species=="Pseudodiploria strigosa")
Bac.seq.raw.pstr<-subset_samples(Bac.seq.raw.pstr, time.point=="final")

Bac.seq.raw.pstr = prune_taxa(taxa_sums(Bac.seq.raw.pstr) > 0, Bac.seq.raw.pstr) 
Bac.seq.raw.pstr.sd <- as(sample_data(Bac.seq.raw.pstr), "data.frame") #sample df

#make unifrac matrix
Bac.seq.wu.ini <- phyloseq::distance(Bac.seq.raw.pstr, method = "wunifrac")
s.u.samp.df.ini <- as(sample_data(Bac.seq.raw.pstr), "data.frame") #sample df
s.u.samp.df.ini$treatment<-as.factor(s.u.samp.df.ini$treatment)
  
# pull out: observed, diversity_shannon, evenness_pielou
erich.tab.obs <-microbiome::alpha(Bac.seq.raw.pstr, index = "observed") 
  erich.tab.obs$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
    erich.tab.obs$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.shan <-microbiome::alpha(Bac.seq.raw.pstr, index = "diversity_shannon")
    erich.tab.shan$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

erich.tab.even <-microbiome::alpha(Bac.seq.raw.pstr, index = "evenness_pielou")
    erich.tab.even$sample_name <- as.factor(s.u.samp.df.ini$sample_name)
        erich.tab.shan$treatment <- as.factor(s.u.samp.df.ini$treatment)

alpha<-merge(erich.tab.obs, erich.tab.even, by.all="sample_name")
alpha<-merge(alpha, erich.tab.shan, by="sample_name")
#write.csv(erich.tab.obs, "erich.tab.obs.csv")
#add meta
alpha<-merge(alpha, s.u.samp.df.ini, by.x="sample_name")

#shannon ####
  hist(alpha$diversity_shannon)
  set.seed(30)
  aov.shannon = aov(diversity_shannon ~ treatment, data=alpha)
    summary(aov.shannon) 
    
#means
shannon_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(diversity_shannon[!is.na(diversity_shannon)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(diversity_shannon, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(diversity_shannon, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(diversity_shannon, na.rm=TRUE) #calculate max, could also calculate min () if desired
);shannon_mean

#set colors
custom_colors <- c("disease" = "#E69F00", "control" = "#56B4E9")  
custom_labels <- c("Control", "SCTLD-Exposed")  # Replace with your actual labels


shannon_plot<-ggplot(data=shannon_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Shannon Diversity"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("P. strigosa") ~ "- Shannon diversity"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));shannon_plot
ggsave("Figures/pstr_shannon.pdf", shannon_plot)

#Richness ####
  hist(alpha$observed)
  set.seed(30)
  aov.observed = aov(observed ~ treatment, data=alpha)
    summary(aov.observed) # away p=0.038
    
#means
observed_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(observed[!is.na(observed)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(observed, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(observed, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(observed, na.rm=TRUE) #calculate max, could also calculate min () if desired
);observed_mean

rich_plot<-ggplot(data=observed_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Richness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("P. strigosa") ~ "- Richness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));rich_plot
ggsave("Figures/pstr_rich.pdf", rich_plot)


#evenness ####
  hist(alpha$evenness_pielou)
  set.seed(30)
  aov.evenness = aov(evenness_pielou ~ treatment, data=alpha)
    summary(aov.evenness) # home p<0.001, away p<0.001, genet p<0.001, home*away p<0.001
    
#means
evenness_mean <- ddply(alpha, c("treatment"), summarise, #summarize cell counts
                 N    = length(evenness_pielou[!is.na(evenness_pielou)]), #calculate the length of the data frame, excluding NA’s
                 mean = mean(evenness_pielou, na.rm=TRUE), #calculate mean of response variable, removing NA's
                 sd   = sd(evenness_pielou, na.rm=TRUE), #calculate standard deviation
                 se   = sd / sqrt(N), #calculate standard error
                 max = max(evenness_pielou, na.rm=TRUE) #calculate max, could also calculate min () if desired
);evenness_mean

even_plot<-ggplot(data=evenness_mean, aes(x=treatment, y=mean, color=treatment)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                width=0.1, show.legend = T)+
  geom_point(aes(color=treatment), size=4, show.legend = F)+
  xlab("") + #Label the X Axis
    ylab("") + #Label the X Axis
  theme_bw() + #Set the background color
  theme(axis.line = element_line(color = 'black'), #Set the axes color
        axis.title=element_text(size=14,face="bold"), #Set axis format
        panel.border = element_blank(), #Set the border
        panel.grid.major = element_blank(), #Set the major gridlines
        panel.grid.minor = element_blank(), #Set the minor gridlines
        text = element_text(size=18),  # set element text
        plot.background =element_blank(), #Set the plot background
        legend.key = element_blank()) + #Set plot legend key
        theme(aspect.ratio=1)+
   ylab(expression(paste("Evenness"))) +
    scale_color_manual(values = custom_colors) + # Apply custom colors
        scale_x_discrete(labels = custom_labels)+
  ggtitle(expression(italic("P. strigosa") ~ "- Evenness"))+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(size=20, face = "italic"));even_plot
ggsave("Figures/pstr_even.pdf", even_plot)

library(grid)

g<-grid.arrange(rich_plot, even_plot, shannon_plot, nrow = 1,ncol=3)
            # widths = c(1, 1, 1),  # Adjust widths as needed
            # heights = c(3),       # Adjust heights as needed
           #  asp = 1)              # Set aspect ratio
ggsave("Figures/pstr_alpha.pdf", g)

```
