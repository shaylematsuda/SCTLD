---
title: "SCTLD_juvies"
output: html_document
date: "2024-04-15"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Data analysis for the 16S SCTLD juvenile experiment

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr) 
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
library(gridExtra)
library(multcomp)
library(reshape)
library(factoextra)
library(reshape2)
library(vegan) 
library(pairwiseAdonis)
library("scales")
packageVersion("scales")
library(RColorBrewer)
library(colorRamps)
library(devtools)
library(phyloseq)
library(readr)
library(vegan)
library(ape)
library(geosphere)
library(ade4)
library(microbiome)  
library(knitr)
```

#Start analysis here: load in RData if needed
```{r}
load("RData/Bac.seq1.RData") #load cleaned data 

#Remove Samples identified below in QC
#remove dups Acer67. Acer67b, Acer272, Acer111, Acer115. Aver68b
#remove Acer 107, Acer 43 no meta
Bac.seq <- subset_samples(Bac.seq, sample_name != "Acer67")



```

#Set up, Bac.s relative abundaces: Bac.seq.rel (Bac.seq for alpha)
```{r}        
#make relative abundance df Bac.seq
Bac.seq.rel  = transform_sample_counts(Bac.seq, function(x) x / sum(x) )  #save as RELA DIVs
data.Bac.seq.rel <- as(sample_data(Bac.seq.rel), "data.frame") #look at samp data
data.Bac.seq.rel = prune_taxa(taxa_sums(Bac.seq.rel) > 0, Bac.seq.rel) #this removes any OTU with 0s

#heatmap
  #plot_heatmap(Bac.s.rel, method = "NMDS", distance = "bray")# way too much data

``` 

Look at all samples + water and ntc - samples separate out well
```{r}
# data.Bac.seq.rel df
Bac.seq.S.rel<-subset_samples (data.Bac.seq.rel, experiment=="SCTLD")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel, time.point!= "bath")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel2, experiment!= "NTC")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel2, experiment!= "MOCK")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel2, experiment!= "FLU")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel2, species!= "Orbicella faveolata")
Bac.seq.S.rel2<-subset_samples(Bac.seq.S.rel2, species!= "Montastrea cavernosa")
Bac.seq.S.rel2.sd <- as(sample_data(Bac.seq.S.rel2), "data.frame") #look at samp data


#make unifrac matrix
Bac.seq.wu.all <- phyloseq::distance(Bac.seq.S.rel2, method = "wunifrac")
s.u.samp.df <- as(sample_data(Bac.seq.S.rel2), "data.frame") #sample df

#adonixs test between sample types: p=0.001 between sample types
set.seed(30)
adonis2(Bac.seq.wu.all ~ time.point*species*treatment, data = s.u.samp.df)


# Homogeneity of dispersion test  - no diffs
    set.seed(30)
    permutest(betadisper(Bac.seq.wu.all, Bac.seq.S.rel2.sd$species, type = "centroid"))
  ball<-  betadisper(Bac.seq.wu.all, Bac.seq.S.rel2.sd$species, type = "centroid")
  TukeyHSD(ball,  ordered = FALSE,conf.level = 0.95)  

#Plot
type.colors <- c("type"= "#D43F3AFF","Swap"="#EEA236FF","Home.nursery"="#5CB85CFF")

#nmds
unifrac.all <- ordinate(Bac.seq.S.rel2, method="NMDS", "unifrac",weighted=TRUE, set.seed(30)) 
stressplot(unifrac.all)
scores.ord.u_RelA_stats<-as.data.frame(cbind(vegan::scores(unifrac.all, display="sites")))  
     unifrac.all.sd <- as(sample_data(Bac.seq.S.rel2), "data.frame") #sample df

scores.ord.u_RelA_stats$species <- unifrac.all.sd$species
scores.ord.u_RelA_stats$treatment <- unifrac.all.sd$treatment
scores.ord.u_RelA_stats$time.point <- unifrac.all.sd$time.point
scores.ord.u_RelA_stats$code<-paste(scores.ord.u_RelA_stats$treatment, scores.ord.u_RelA_stats$time.point)
#plot samps vs  Mock community
ggplot(scores.ord.u_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = code, shape=time.point), size = 4) +
    scale_color_manual(values=c("darkblue","#56B4E9","red"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = code), linetype = 2) +
  ggtitle("NMDS 16s by sample type") +
  theme_classic()+
  facet_wrap(~species)


initial.only<-subset(scores.ord.u_RelA_stats, time.point=="Initial")
ggplot(scores.ord.u_RelA_stats, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(colour = species), size = 4) +
    scale_color_manual(values=c("orange","turquoise3","seagreen"))+
  stat_ellipse(aes(x = NMDS1, y = NMDS2, colour = species), linetype = 2) +
  ggtitle("Microbiome NMDS") +
  theme_classic()
```


#### By speices:####
```{r}
#Cnat
Bac.seq.cnat<-subset_samples(Bac.seq.S.rel2, species== "Colpophyllia natans")
Bac.seq.cnat = prune_taxa(taxa_sums(Bac.seq.cnat) > 0, Bac.seq.cnat) #this removes any OTU with 0s

Bac.seq.cnat.sd <- as(sample_data(Bac.seq.cnat), "data.frame") #look at samp data
Bac.seq.cnat.sd$code<-paste(Bac.seq.cnat.sd$treatment, Bac.seq.cnat.sd$time.point)

#make unifrac matrix
Bac.seq.wu.cnat <- phyloseq::distance(Bac.seq.cnat, method = "wunifrac")
s.u.samp.cnat.df <- as(sample_data(Bac.seq.cnat), "data.frame") #sample df
s.u.samp.cnat.df$code<-paste(s.u.samp.cnat.df$treatment, s.u.samp.cnat.df$time.point)

#adonixs test between sample types: p=0.001 between sample types
set.seed(30)
adonis2(Bac.seq.wu.cnat ~ code, data = Bac.seq.cnat.sd)

# Homogeneity of dispersion test  
    set.seed(30) 
    permutest(betadisper(Bac.seq.wu.cnat, s.u.samp.cnat.df$code, type = "centroid"))  # p =0.001
  ball<-  betadisper(Bac.seq.wu.cnat, s.u.samp.cnat.df$code, type = "centroid")
  TukeyHSD(ball,  ordered = FALSE,conf.level = 0.95)
  #### CRF is different than all others in dispersion. 





```


```{r}
# pull out: observed, diversity_shannon, evenness_pielou
erich.tab.obs <-microbiome::alpha(Bac.seq.c, index = "observed") 
  erich.tab.obs$frag.id <- as.factor(Bac.seq.c.sd$frag.id)
erich.tab.shan <-microbiome::alpha(Bac.seq.c, index = "diversity_shannon")
    erich.tab.shan$frag.id <- as.factor(Bac.seq.c.sd$frag.id)
erich.tab.even <-microbiome::alpha(Bac.seq.c, index = "evenness_pielou")
    erich.tab.even$frag.id <- as.factor(Bac.seq.c.sd$frag.id)

alpha<-merge(erich.tab.obs, erich.tab.even, by.all="frag.id")
alpha<-merge(alpha, erich.tab.shan, by="frag.id")
#write.csv(erich.tab.obs, "erich.tab.obs.csv")
#add meta
alpha<-merge(alpha, Bac.seq.c.sd, by.x="frag.id")

#ANOVAS
```


